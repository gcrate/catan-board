<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Catan Board</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 10px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
            color: #ffd700;
        }

        .mode-indicator {
            text-align: center;
            padding: 8px;
            border-radius: 20px;
            margin-bottom: 15px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .mode-setup {
            background: #4a69bd;
        }

        .mode-play {
            background: #27ae60;
        }

        /* Hex Board Display */
        .board-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .board {
            position: relative;
            width: 400px;
            height: 360px;
        }

        .hex {
            position: absolute;
            width: 80px;
            height: 70px;
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .hex:active {
            transform: scale(0.95);
        }

        .hex .token {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 42px;
            height: 42px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .hex .number {
            font-size: 1.4rem;
            color: #000;
            line-height: 1;
        }

        .hex .number.red {
            color: #c0392b;
        }

        .hex .resource-icon {
            font-size: 1.2rem;
            line-height: 1;
        }

        .hex .desert-icon {
            font-size: 1.8rem;
        }

        .hex.blink {
            animation: blinkAnim 0.3s ease-in-out;
        }

        @keyframes blinkAnim {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(2); box-shadow: 0 0 20px #fff; }
        }

        /* Resource colors */
        .hex.brick { background: #b54a32; }
        .hex.wood { background: #228b22; }
        .hex.sheep { background: #90ee90; }
        .hex.wheat { background: #ffd700; }
        .hex.ore { background: #808080; }
        .hex.desert { background: #eed6af; }

        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: transform 0.1s, opacity 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #ffd700;
            color: #1a1a2e;
        }

        .btn-secondary {
            background: #4a69bd;
            color: #fff;
        }

        .btn-success {
            background: #27ae60;
            color: #fff;
        }

        .btn-danger {
            background: #c0392b;
            color: #fff;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: #2c3e50;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .tab.active {
            background: #4a69bd;
        }

        /* Dice Display */
        .dice-display {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .die {
            width: 60px;
            height: 60px;
            background: #fff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: #1a1a2e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .roll-total {
            text-align: center;
            font-size: 1.5rem;
            margin: 10px 0;
        }

        /* Manual Roll Input */
        .number-buttons {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .num-btn {
            padding: 15px 10px;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            background: #3498db;
            color: #fff;
            transition: transform 0.1s, background 0.2s;
        }

        .num-btn:active {
            transform: scale(0.95);
        }

        .num-btn:hover {
            background: #2980b9;
        }

        .num-btn.seven {
            background: #e74c3c;
        }

        .num-btn.seven:hover {
            background: #c0392b;
        }

        .btn:disabled,
        .num-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:disabled:active,
        .num-btn:disabled:active {
            transform: none;
        }

        /* Config Panel */
        .config-panel {
            background: #2c3e50;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }

        .config-panel.show {
            display: block;
        }

        .config-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #34495e;
        }

        .config-row:last-child {
            border-bottom: none;
        }

        .config-row label {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-row .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .config-row input[type="number"] {
            width: 60px;
            padding: 8px;
            border: none;
            border-radius: 5px;
            text-align: center;
            background: #1a1a2e;
            color: #fff;
            font-size: 1rem;
        }

        .config-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .total-count {
            text-align: center;
            padding: 10px;
            font-weight: bold;
        }

        .total-count.valid {
            color: #27ae60;
        }

        .total-count.invalid {
            color: #c0392b;
        }

        /* Section visibility */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Matching tiles list */
        .matching-list {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .matching-tile {
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: bold;
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèùÔ∏è Catan Board</h1>
        
        <div class="mode-indicator" id="modeIndicator">Setup Mode</div>

        <!-- Board Display -->
        <div class="board-container">
            <div class="board" id="board"></div>
        </div>

        <!-- Setup Mode Section -->
        <div class="section active" id="setupSection">
            <button class="btn btn-primary" onclick="randomize()">üé≤ Randomize Board</button>
            <button class="btn btn-secondary" onclick="toggleConfig()">‚öôÔ∏è Customize</button>
            
            <div class="config-panel" id="configPanel">
                <h3 style="margin-bottom: 10px;">Resource Counts</h3>
                <p style="font-size: 0.8rem; color: #7f8c8d; margin-bottom: 10px;">Desert is always in center</p>
                <div class="config-row">
                    <label><span class="color-dot" style="background: #b54a32;"></span> Brick</label>
                    <input type="number" id="cfg-brick" value="3" min="0" max="18" onchange="updateTotal()">
                </div>
                <div class="config-row">
                    <label><span class="color-dot" style="background: #228b22;"></span> Wood</label>
                    <input type="number" id="cfg-wood" value="4" min="0" max="18" onchange="updateTotal()">
                </div>
                <div class="config-row">
                    <label><span class="color-dot" style="background: #90ee90;"></span> Sheep</label>
                    <input type="number" id="cfg-sheep" value="4" min="0" max="18" onchange="updateTotal()">
                </div>
                <div class="config-row">
                    <label><span class="color-dot" style="background: #ffd700;"></span> Wheat</label>
                    <input type="number" id="cfg-wheat" value="4" min="0" max="18" onchange="updateTotal()">
                </div>
                <div class="config-row">
                    <label><span class="color-dot" style="background: #808080;"></span> Ore</label>
                    <input type="number" id="cfg-ore" value="3" min="0" max="18" onchange="updateTotal()">
                </div>
                <div class="total-count" id="totalCount">Total: 18 ‚úì</div>
                
                <h3 style="margin: 15px 0 10px;">Options</h3>
                <div class="config-row">
                    <label>Prevent adjacent 6 & 8</label>
                    <input type="checkbox" id="cfg-prevent68">
                </div>
            </div>

            <button class="btn btn-success" onclick="startGame()">‚ñ∂Ô∏è Start Game</button>
        </div>

        <!-- Play Mode Section -->
        <div class="section" id="playSection">
            <div class="tabs">
                <div class="tab active" id="tabAuto" onclick="switchTab('auto')">üé≤ Auto Roll</div>
                <div class="tab" id="tabManual" onclick="switchTab('manual')">‚úèÔ∏è Manual Entry</div>
            </div>

            <!-- Auto Roll -->
            <div id="autoRollSection">
                <div class="dice-display">
                    <div class="die" id="die1">?</div>
                    <div class="die" id="die2">?</div>
                </div>
                <div class="roll-total" id="rollTotal">Roll the dice!</div>
                <button class="btn btn-primary" onclick="autoRoll()">üé≤ Roll Dice</button>
            </div>

            <!-- Manual Roll -->
            <div id="manualRollSection" style="display: none;">
                <div class="number-buttons">
                    <button class="num-btn" onclick="manualRoll(2)">2</button>
                    <button class="num-btn" onclick="manualRoll(3)">3</button>
                    <button class="num-btn" onclick="manualRoll(4)">4</button>
                    <button class="num-btn" onclick="manualRoll(5)">5</button>
                    <button class="num-btn" onclick="manualRoll(6)">6</button>
                    <button class="num-btn seven" onclick="manualRoll(7)">7</button>
                    <button class="num-btn" onclick="manualRoll(8)">8</button>
                    <button class="num-btn" onclick="manualRoll(9)">9</button>
                    <button class="num-btn" onclick="manualRoll(10)">10</button>
                    <button class="num-btn" onclick="manualRoll(11)">11</button>
                    <button class="num-btn" onclick="manualRoll(12)">12</button>
                </div>
                <div class="roll-total" id="manualRollTotal">Tap a number</div>
            </div>

            <div class="matching-list" id="matchingList"></div>

            <button class="btn btn-danger" onclick="backToSetup()">‚Ü©Ô∏è Back to Setup</button>
        </div>
    </div>

    <script>
        // Hex positions for flat-top hexes (wider)
        // Flat-top hex: width=80, height=70
        // Horizontal spacing = width * 0.75 = 60, Vertical spacing = height = 70
        const HEX_POSITIONS = [
            // Center (index 0)
            { x: 160, y: 140 },
            // Ring 1 (indices 1-6) - going clockwise from top-right
            { x: 220, y: 105 },  // 1: top right
            { x: 220, y: 175 },  // 2: bottom right
            { x: 160, y: 210 },  // 3: bottom
            { x: 100, y: 175 },  // 4: bottom left
            { x: 100, y: 105 },  // 5: top left
            { x: 160, y: 70 },   // 6: top
            // Ring 2 (indices 7-18) - going clockwise from top-right
            { x: 220, y: 35 },   // 7
            { x: 280, y: 70 },   // 8
            { x: 280, y: 140 },  // 9
            { x: 280, y: 210 },  // 10
            { x: 220, y: 245 },  // 11
            { x: 160, y: 280 },  // 12
            { x: 100, y: 245 },  // 13
            { x: 40, y: 210 },   // 14
            { x: 40, y: 140 },   // 15
            { x: 40, y: 70 },    // 16
            { x: 100, y: 35 },   // 17
            { x: 160, y: 0 }    // 18

        ];

        let currentMode = 'setup';
        let currentTab = 'auto';
        let boardState = { tiles: [] };
        let rollCooldown = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchState();
        });

        async function fetchState() {
            try {
                const response = await fetch('/api/state');
                boardState = await response.json();
                currentMode = boardState.mode;
                renderBoard();
                updateModeUI();
            } catch (e) {
                console.error('Error fetching state:', e);
            }
        }

        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';

            boardState.tiles.forEach((tile, index) => {
                const hex = document.createElement('div');
                hex.className = `hex ${tile.resource || ''}`;
                hex.id = `hex-${index}`;
                
                const pos = HEX_POSITIONS[index];
                hex.style.left = pos.x + 'px';
                hex.style.top = pos.y + 'px';

                if (tile.number) {
                    const isRed = tile.number === 6 || tile.number === 8;
                    hex.innerHTML = `
                        <div class="token">
                            <span class="number ${isRed ? 'red' : ''}">${tile.number}</span>
                            <span class="resource-icon">${getResourceIcon(tile.resource)}</span>
                        </div>
                    `;
                } else if (tile.resource === 'desert') {
                    hex.innerHTML = `<span class="desert-icon">üèúÔ∏è</span>`;
                } else if (tile.resource) {
                    hex.innerHTML = `<span class="resource-icon">${getResourceIcon(tile.resource)}</span>`;
                }

                // Add click handler for setup mode testing
                hex.addEventListener('click', () => {
                    if (currentMode === 'setup') {
                        flashHex(index);
                    }
                });

                board.appendChild(hex);
            });
        }

        async function flashHex(index) {
            // Flash on UI
            const hex = document.getElementById(`hex-${index}`);
            if (hex) {
                hex.classList.add('blink');
                setTimeout(() => hex.classList.remove('blink'), 900);
            }

            // Tell backend to flash the LED
            try {
                await fetch('/api/flash_led', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tile_index: index })
                });
            } catch (e) {
                console.error('Error flashing LED:', e);
            }
        }

        function getResourceIcon(resource) {
            const icons = {
                brick: 'üß±',
                wood: 'ü™µ',
                sheep: 'üêë',
                wheat: 'üåæ',
                ore: 'ü™®',
                desert: 'üèúÔ∏è'
            };
            return icons[resource] || '';
        }

        function updateModeUI() {
            const indicator = document.getElementById('modeIndicator');
            const setupSection = document.getElementById('setupSection');
            const playSection = document.getElementById('playSection');

            if (currentMode === 'setup') {
                indicator.textContent = 'Setup Mode';
                indicator.className = 'mode-indicator mode-setup';
                setupSection.classList.add('active');
                playSection.classList.remove('active');
            } else {
                indicator.textContent = 'Play Mode';
                indicator.className = 'mode-indicator mode-play';
                setupSection.classList.remove('active');
                playSection.classList.add('active');
            }
        }

        function toggleConfig() {
            const panel = document.getElementById('configPanel');
            panel.classList.toggle('show');
        }

        function updateTotal() {
            const resources = ['brick', 'wood', 'sheep', 'wheat', 'ore'];
            let total = 0;
            resources.forEach(r => {
                total += parseInt(document.getElementById(`cfg-${r}`).value) || 0;
            });
            
            const totalDiv = document.getElementById('totalCount');
            if (total === 18) {
                totalDiv.textContent = `Total: ${total} ‚úì`;
                totalDiv.className = 'total-count valid';
            } else {
                totalDiv.textContent = `Total: ${total} (need 18)`;
                totalDiv.className = 'total-count invalid';
            }
        }

        function getConfig() {
            return {
                resources: {
                    brick: parseInt(document.getElementById('cfg-brick').value) || 0,
                    wood: parseInt(document.getElementById('cfg-wood').value) || 0,
                    sheep: parseInt(document.getElementById('cfg-sheep').value) || 0,
                    wheat: parseInt(document.getElementById('cfg-wheat').value) || 0,
                    ore: parseInt(document.getElementById('cfg-ore').value) || 0
                },
                prevent_adjacent_68: document.getElementById('cfg-prevent68').checked,
                numbers: [2, 3, 3, 4, 4, 5, 5, 6, 6, 8, 8, 9, 9, 10, 10, 11, 11, 12]
            };
        }

        async function randomize() {
            const config = getConfig();
            const total = Object.values(config.resources).reduce((a, b) => a + b, 0);
            
            if (total !== 18) {
                alert('Resource counts must add up to 18!');
                return;
            }

            try {
                const response = await fetch('/api/randomize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                boardState = await response.json();
                renderBoard();
            } catch (e) {
                console.error('Error randomizing:', e);
            }
        }

        async function startGame() {
            if (!boardState.tiles || !boardState.tiles[0].resource) {
                alert('Please randomize the board first!');
                return;
            }

            try {
                const response = await fetch('/api/start_game', { method: 'POST' });
                boardState = await response.json();
                currentMode = 'play';
                updateModeUI();
                resetRollDisplay();
            } catch (e) {
                console.error('Error starting game:', e);
            }
        }

        async function backToSetup() {
            if (!confirm('Are you sure?')) {
                return;
            }

            try {
                const response = await fetch('/api/back_to_setup', { method: 'POST' });
                boardState = await response.json();
                currentMode = 'setup';
                updateModeUI();
            } catch (e) {
                console.error('Error:', e);
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tabAuto').classList.toggle('active', tab === 'auto');
            document.getElementById('tabManual').classList.toggle('active', tab === 'manual');
            document.getElementById('autoRollSection').style.display = tab === 'auto' ? 'block' : 'none';
            document.getElementById('manualRollSection').style.display = tab === 'manual' ? 'block' : 'none';
            resetRollDisplay();
        }

        function setRollCooldown() {
            rollCooldown = true;
            const rollBtn = document.querySelector('#autoRollSection .btn-primary');
            if (rollBtn) rollBtn.disabled = true;
            
            const numBtns = document.querySelectorAll('.num-btn');
            numBtns.forEach(btn => btn.disabled = true);
            
            setTimeout(() => {
                rollCooldown = false;
                if (rollBtn) rollBtn.disabled = false;
                numBtns.forEach(btn => btn.disabled = false);
            }, 2000);
        }

        function resetRollDisplay() {
            document.getElementById('die1').textContent = '?';
            document.getElementById('die2').textContent = '?';
            document.getElementById('rollTotal').textContent = 'Roll the dice!';
            document.getElementById('manualRollTotal').textContent = 'Tap a number';
            document.getElementById('matchingList').innerHTML = '';
        }

        async function autoRoll() {
            if (rollCooldown) return;
            
            try {
                const response = await fetch('/api/roll', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ auto: true })
                });
                const result = await response.json();
                
                document.getElementById('die1').textContent = result.die1;
                document.getElementById('die2').textContent = result.die2;
                document.getElementById('rollTotal').textContent = `Total: ${result.total}`;
                
                highlightMatching(result.total, result.matching);
                setRollCooldown();
            } catch (e) {
                console.error('Error rolling:', e);
            }
        }

        async function manualRoll(value) {
            if (rollCooldown) return;
            
            try {
                const response = await fetch('/api/roll', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ auto: false, value: value })
                });
                const result = await response.json();
                
                document.getElementById('manualRollTotal').textContent = `Rolled: ${result.total}`;
                
                highlightMatching(result.total, result.matching);
                setRollCooldown();
            } catch (e) {
                console.error('Error:', e);
            }
        }

        function highlightMatching(number, matching) {
            // Clear previous highlights
            document.querySelectorAll('.hex').forEach(h => h.classList.remove('blink'));
            
            // Show matching tiles
            const list = document.getElementById('matchingList');
            if (number === 7) {
                list.innerHTML = '<span style="color: #e74c3c;">üè¥‚Äç‚ò†Ô∏è Robber!</span>';
            } else if (matching.length === 0) {
                list.innerHTML = '<span style="color: #7f8c8d;">No matches</span>';
            } else {
                list.innerHTML = matching.map(m => {
                    const colorClass = m.resource;
                    return `<span class="matching-tile ${colorClass}">${getResourceIcon(m.resource)}</span>`;
                }).join('');
                
                // Blink matching hexes
                matching.forEach(m => {
                    const hex = document.getElementById(`hex-${m.index}`);
                    if (hex) {
                        hex.classList.add('blink');
                        setTimeout(() => hex.classList.remove('blink'), 900);
                    }
                });
            }
        }
    </script>
</body>
</html>
